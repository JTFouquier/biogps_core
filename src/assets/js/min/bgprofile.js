(function(b){b.metadata.setType("attr","data");var a=function(c){return new wrapper(c)};biogps.friendControls=a;a.init=function(){var c=b("#meta_profile").metadata();a.profile_fqu=c.fqu;a.renderFriendButton()};a.renderFriendButton=function(){var c="<a onClick='biogps.friendControls.renderMessageBox();return false;' href='#' class='roundButton'>Add as a Friend</a>";b("#profileFriend").html(c)};a.renderMessageBox=function(){var d=b("#friendMessageBox"),f=100,e=Math.max((b(window).width()-d.outerWidth())/2,0),c="<h2>Add a Friend</h2><p>Write a message to be included with your friend request:</p><form action='javascript:void(null)' onsubmit='biogps.friendControls.addFriend(this,event);return false;'><textarea name='message' rows='3' cols='40'>I'd like to add you to my BioGPS network.</textarea><br><input type='submit' value='Send Request'></form><div class='profileControls'><a id='friendBoxClose' href='#'>close [x]</a></div>";d.html(c);b("#friendBoxClose").click(function(){b("#friendMessageBox").hide();b(".popup-mask").hide()});b(".popup-mask").show();d.css({top:f,left:e,position:"absolute"});d.show()};a.renderLoading=function(){var c="<span class='roundButton'><img src='/assets/img/loading.gif'>&nbsp;&nbsp;Contacting server</span>";b("#profileFriend").html(c)};a.renderRequestSent=function(){var c="<span class='roundButton'>Friend Request Sent</span>";b("#profileFriend").html(c)};a.renderRequestFail=function(d){if(!d){d="Unknown server error."}var c="Request failed: <span class='error_message'>"+d+"</span>";b("#profileFriend").html(c)};a.addFriend=function(e,c){if(c){c.cancelBubble=true}var d={extAction:"friends",extMethod:"invite_friend",extTID:3,extType:"rpc",extUpload:false,message:e.message.value.trim(),to_user:a.profile_fqu};b.ajax({async:true,data:b.param(d),dataType:"json",type:"post",url:"/extdirect/remoting/router/",beforeSend:function(f){b("#friendBoxClose").click();a.renderLoading()},success:function(f){if(f.result.success){a.renderRequestSent()}else{a.renderRequestFail(f.result.message)}},failure:function(f){a.renderRequestFail(f.result.message)}})}})(jQuery);jQuery(document).ready(function(){if(jQuery("#profileFriend").length>0){biogps.friendControls.init()}});(function(c){c.metadata.setType("attr","data");var a=function(d){return new wrapper(d)};biogps.profileControls=a;a.init=function(){var g=c("#meta_profile").metadata(),e=c("#meta_privacy").metadata(),f=c("#meta_info").metadata(),d=c("#meta_links").metadata();if(!f[0]["name"]){f=[]}if(!d[0]["name"]){d=[]}c.each(f,function(h,j){j.body=j.body.replace(/<br \/>/g,"\n")});a.profile_id=g.id;a.privacy=e;a.info=f;a.links=d;a.renderPrivacyForm();a.renderInfo();a.renderLinks();c("#privacyLink").click(function(){var h=c("#profileControlBox"),j=100,i=Math.max((c(window).width()-h.outerWidth())/2,0);c(".popup-mask").show();h.css({top:j,left:i,position:"absolute"});h.show()})};var b={profilePriv:"<span class='profilePrivacyField'>             <select name='<%= name %>' onChange='biogps.profileControls.submitPrivacy(this);'>                 <option value='public' <% if(current==='public'){ %>selected='selected'<% }; %>>Public</option>                 <option value='friends' <% if(current==='friends'){ %>selected='selected'<% }; %>>Friends Only</option>                 <option value='private' <% if(current==='private'){ %>selected='selected'<% }; %>>Private (Hidden)</option>             </select></span>",infoForm:"<% $.each(info, function(k,i) { %>             <div class='profileInfoField'>                 <label>Name:</label>&nbsp;                 <input type='text' value='<%= i.name %>' size='40' />                 <br>                <label>Body Text:</label><br>                 <textarea rows='5' cols='65'><%= i.body.replace(/<br \\/>/g,'\\n') %></textarea>             </div><div class='orbar'></div>             <% }); %>",infoRender:"<% $.each(info, function(k,i) { %>             <h2><%= i.name %></h2> 		    <%= i.body.replace(/\\n/g,'<br \\/>') %> 		    <br>&nbsp; 		    <% }); %> 		    <div class='profileControls'> 		    <input type='button' value='Edit Info' onClick='biogps.profileControls.renderInfoForm();' /></div>",linkForm:"<% $.each(links, function(k,i) { %>             <% if(i.url==''){i.url='http://'} %>             <div class='profileLinkField'>                 <label>Name:</label>&nbsp;                 <input type='text' value='<%= i.name %>' class='profileLinkName' /><br>                 <label>URL:</label>&nbsp;&nbsp;&nbsp;                 <input type='text' value='<%= i.url %>' class='profileLinkUrl' size='25' />             </div><div class='orbar'></div>             <% }); %>",linkRender:"<ul><% $.each(links, function(k,i) { %>             <li><a href='<%= i.url %>' target='_blank'><%= i.name %></a></li> 		    <% }); %> 		    </ul><div class='profileControls'> 		    <input type='button' value='Edit Links' onClick='biogps.profileControls.renderLinkForm();' /></div>"};a.renderPrivacyForm=function(){c("#profilePrivacy").html("<h2>Profile Privacy Control</h2><br><div>Affiliation:"+c.template(b.profilePriv,{name:"name_visible",current:a.privacy.name_visible})+"</div><br><div>Email address:"+c.template(b.profilePriv,{name:"email_visible",current:a.privacy.email_visible})+"</div><br><div>My profile details: "+c.template(b.profilePriv,{name:"profile_visible",current:a.privacy.profile_visible})+"<p class='smallNote'>(posted info, links and friends.)</p></div>             <div class='profileControls'><a id='privacyLinkClose' href='#'>close [x]</a></div>");c("#privacyLinkClose").click(function(){c("#profileControlBox").hide();c(".popup-mask").hide()})};a.renderInfoForm=function(){var d="<h2>Edit your Info</h2><div id='profileInfoFields'>"+c.template(b.infoForm,{info:a.info})+"</div><div class='profileControls'>             <input type='button' value='Add More (+)' onClick='biogps.profileControls.renderBlankInfoForm();' />             <input type='button' value='SAVE' onClick='biogps.profileControls.submitInfo();' />&nbsp;&nbsp;&nbsp;             <input type='button' value='Cancel' onClick='biogps.profileControls.cancelInfo();' />             </div>";c("#profileInfo").html(d);if(a.info.length<1){a.renderBlankInfoForm()}};a.renderBlankInfoForm=function(){var e=[{name:"",body:""}],d=c.template(b.infoForm,{info:e});c("#profileInfoFields").append(d)};a.renderInfo=function(){var d="";if(a.info.length<1){d="<h2>Info</h2>You haven't shared any info about yourself yet."}d+=c.template(b.infoRender,{info:a.info});c("#profileInfo").html(d)};a.cancelInfo=a.renderInfo;a.renderLinkForm=function(){var d="<h2>Edit your Links</h2><div id='profileLinkFields'>"+c.template(b.linkForm,{links:a.links})+"</div><div class='profileControls'>             <input type='button' value='Add More (+)' onClick='biogps.profileControls.renderBlankLinkForm();' />             <input type='button' value='SAVE' onClick='biogps.profileControls.submitLinks();' />&nbsp;&nbsp;&nbsp;             <input type='button' value='Cancel' onClick='biogps.profileControls.cancelLinks();' />             </div>";c("#profileLinks").html(d);if(a.links.length<1){a.renderBlankLinkForm()}};a.renderBlankLinkForm=function(){var e=[{name:"",url:""}],d=c.template(b.linkForm,{links:e});c("#profileLinkFields").append(d)};a.renderLinks=function(){var d="<h2>Links</h2>";if(a.links.length<1){d+="You haven't shared any links yet."}d+=c.template(b.linkRender,{links:a.links});c("#profileLinks").html(d)};a.cancelLinks=a.renderLinks;a.submitPrivacy=function(d){var e=c(d);a.privacy[e[0].name]=e.val();a.submit()};a.submitInfo=function(){var g=c(".profileInfoField input").map(function(){return this.value}).get();var d=c(".profileInfoField textarea").map(function(){return this.value}).get();var f=[];for(var e=0;e<g.length;e++){if(g[e]==""){continue}f[e]={name:g[e],body:d[e]}}a.info=f;a.submit();a.renderInfo()};a.submitLinks=function(){var g=c(".profileLinkName").map(function(){return this.value}).get();var f=c(".profileLinkUrl").map(function(){return this.value}).get();var d=[];for(var e=0;e<g.length;e++){if(g[e]==""){continue}d[e]={name:g[e],url:f[e]}}a.links=d;a.submit();a.renderLinks()};a.submit=function(){var d={info:c.toJSON(a.info),links:c.toJSON(a.links),privacy:c.toJSON(a.privacy)};c.ajax({async:true,data:c.param(d),dataType:"json",type:"post",url:"/profile/edit/",beforeSend:function(e){c("#savingProfile").html('<img src="/assets/img/loading.gif">&nbsp;&nbsp;SAVING PROFILE').show()},success:function(e){c("#savingProfile").html("PROFILE SAVED").delay(2000).fadeOut(600)}});ga("send","pageview","/profile/edit/"+a.profile_id)}})(jQuery);jQuery(document).ready(function(){if(jQuery("#meta_info").length>0){biogps.profileControls.init()}});